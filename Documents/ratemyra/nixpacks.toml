[phases.setup]
nixPkgs = ["nodejs-18_x"]

[phases.install]
cmds = [
  "npm install || true",
  "(cd server && npm install)",
  "(cd client && npm install)"
]

[phases.build]
cmds = [
  "echo 'üî® Starting build phase...'",
  "echo 'üì¶ Building Prisma client...'",
  "(cd server && npx prisma generate || echo '‚ö†Ô∏è Prisma generate failed (non-critical)')",
  "echo 'üé® Building frontend...'",
  "(cd client && rm -rf dist && npm run build)",
  "echo '‚úÖ Verifying build output...'",
  "(cd client && test -d dist && echo '‚úÖ dist/ folder exists' && ls -la dist/ | head -10 || (echo '‚ùå dist/ folder NOT found!' && exit 1))",
  "echo '‚úÖ Build phase completed successfully!'"
]

[phases.release]
cmds = [
  "echo 'üîÑ Release phase: Running migrations...'",
  "echo 'DATABASE_URL available:' $([ -n \"$DATABASE_URL\" ] && echo 'YES' || echo 'NO')",
  "(cd server && npx prisma migrate deploy 2>&1 || (echo '‚ö†Ô∏è Migration command failed' && echo 'Exit code:' $? && echo 'This is OK - migrations can be run via /api/setup'))"
]

[start]
cmd = "cd server && npm start"
