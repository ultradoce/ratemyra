// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model School {
  id        String   @id @default(cuid())
  name      String   @unique
  domain    String? // .edu domain
  location  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ras       RA[]
  users     User[]

  @@index([name])
}

model RA {
  id        String   @id @default(cuid())
  firstName String
  lastName  String
  schoolId  String
  dorm      String? // Dormitory/hall name
  floor     String? // Floor number
  legacyId  String? // For merging profiles
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  school   School      @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  reviews  Review[]
  tagStats RATagStat[]

  @@index([schoolId, firstName, lastName])
  @@index([legacyId])
}

model Review {
  id                    String       @id @default(cuid())
  raId                  String
  userId                String? // Optional: for logged-in users who can edit
  courseCode            String? // Optional: if RA taught a class
  semesters             String[] // Array of semesters (e.g., ["Fall 2024", "Spring 2025"])
  ratingClarity         Int          @db.SmallInt // 1-5
  ratingHelpfulness     Int          @db.SmallInt // 1-5
  ratingOverall         Float // Derived/calculated
  difficulty            Int          @db.SmallInt // 1-5
  wouldTakeAgain        Boolean? // Would take this RA again (RMP-style)
  tags                  String[] // Array of tag codes
  attendanceRequired    Boolean      @default(false)
  textBody              String?      @db.Text
  timestamp             DateTime     @default(now())
  ipHash                String // Hashed IP for abuse prevention
  deviceFingerprintHash String? // Hashed device fingerprint
  helpfulCount          Int          @default(0) // Number of helpful votes
  notHelpfulCount       Int          @default(0) // Number of not helpful votes
  status                ReviewStatus @default(ACTIVE)
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt

  ra    RA           @relation(fields: [raId], references: [id], onDelete: Cascade)
  user  User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  likes ReviewLike[]

  @@index([raId, status])
  @@index([userId])
  @@index([ipHash])
  @@index([deviceFingerprintHash])
  @@index([ipHash, deviceFingerprintHash])
  @@index([timestamp])
  @@index([status])
}

enum ReviewStatus {
  ACTIVE
  FLAGGED
  HIDDEN
  REMOVED
}

model RATagStat {
  id        String   @id @default(cuid())
  raId      String
  tag       String // Tag code like "TOUGH_GRADER", "CLEAR_LECTURES"
  count     Int      @default(0)
  updatedAt DateTime @updatedAt

  ra RA @relation(fields: [raId], references: [id], onDelete: Cascade)

  @@unique([raId, tag])
  @@index([raId])
}

enum UserRole {
  ADMIN
  USER
}

model User {
  id                       String    @id @default(cuid())
  email                    String    @unique
  password                 String // Hashed
  role                     UserRole  @default(USER)
  schoolId                 String?
  emailVerified            Boolean   @default(false)
  verificationToken        String?   @unique
  verificationTokenExpires DateTime?
  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt

  school          School?           @relation(fields: [schoolId], references: [id])
  reviews         Review[]
  reviewLikes     ReviewLike[]
  helpMessages    HelpMessage[]

  @@index([email])
  @@index([role])
  @@index([verificationToken])
  @@index([emailVerified])
}

model ReviewLike {
  id                    String   @id @default(cuid())
  reviewId              String
  userId                String? // Optional: for logged-in users
  ipHash                String // Hashed IP for anonymous users
  deviceFingerprintHash String? // Device fingerprint
  isHelpful             Boolean // true = helpful, false = not helpful
  createdAt             DateTime @default(now())

  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@unique([reviewId, userId])
  @@unique([reviewId, ipHash, deviceFingerprintHash])
  @@index([reviewId])
  @@index([userId])
}

model HelpMessage {
  id          String            @id @default(cuid())
  name        String
  email       String
  subject     String
  message     String            @db.Text
  status      HelpMessageStatus @default(UNREAD)
  userId      String? // Optional: if submitted by logged-in user
  adminNotes  String?           @db.Text // Admin notes/response
  respondedAt DateTime?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([createdAt])
  @@index([userId])
}

enum HelpMessageStatus {
  UNREAD
  READ
  IN_PROGRESS
  RESOLVED
  ARCHIVED
}
